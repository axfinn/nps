<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NPC å®¢æˆ·ç«¯</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 12px; }
        h1 { font-size: 24px; margin-bottom: 8px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .version { color: #666; font-size: 14px; }
        .status-row { display: flex; gap: 12px; margin-bottom: 20px; }
        .status-item { flex: 1; background: #f8f9fa; padding: 12px 16px; border-radius: 8px; }
        .status-label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .status-value { font-size: 14px; font-weight: 500; }
        .status-value.running { color: #28a745; }
        .status-value.stopped { color: #dc3545; }
        .status-value.not_installed { color: #6c757d; }
        .form-group { margin-bottom: 16px; }
        .form-row { display: flex; gap: 16px; }
        .form-row .form-group { flex: 1; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 14px; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .checkbox-group { display: flex; align-items: center; gap: 8px; }
        .checkbox-group input { width: auto; }
        .checkbox-group label { margin-bottom: 0; font-weight: normal; }
        .radio-group { display: flex; gap: 20px; }
        .radio-group label { display: flex; align-items: center; gap: 6px; font-weight: normal; cursor: pointer; }
        .btn-row { display: flex; gap: 12px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm { padding: 8px 16px; font-size: 13px; flex: none; }
        .logs { background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 8px; font-family: "SF Mono", Monaco, monospace; font-size: 12px; height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
        .logs::-webkit-scrollbar { width: 8px; }
        .logs::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .alert-warning { background: #fff3cd; color: #856404; }
        .service-btns { display: flex; gap: 8px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>NPC å†…ç½‘ç©¿é€å®¢æˆ·ç«¯</h1>
                <span class="version">v<span id="version">-</span></span>
            </div>

            <div class="status-row">
                <div class="status-item">
                    <div class="status-label">å½“å‰çŠ¶æ€</div>
                    <div id="runStatus" class="status-value stopped">å·²åœæ­¢</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ç³»ç»ŸæœåŠ¡</div>
                    <div id="svcStatus" class="status-value not_installed">æœªå®‰è£…</div>
                </div>
            </div>

            <div class="btn-row">
                <button id="btnStart" class="btn btn-success" onclick="startClient()">å¯åŠ¨è¿æ¥</button>
                <button id="btnStop" class="btn btn-danger" style="display:none" onclick="stopClient()">åœæ­¢è¿æ¥</button>
                <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
                <button class="btn btn-secondary" onclick="clearConfig()">æ¸…é™¤é…ç½®</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">è¿æ¥é…ç½®</div>
            <div class="alert alert-info" style="font-size: 13px; margin-bottom: 16px;">
                <strong>é…ç½®è¯´æ˜ï¼š</strong>
                <ol style="margin: 8px 0 0 0; padding-left: 20px; line-height: 1.6;">
                    <li>åœ¨ NPS æœåŠ¡ç«¯ Web ç®¡ç†ç•Œé¢åˆ›å»ºå®¢æˆ·ç«¯</li>
                    <li>å¤åˆ¶æœåŠ¡ç«¯åœ°å€ï¼ˆIP:ç«¯å£ï¼‰å’Œå®¢æˆ·ç«¯çš„ Vkey</li>
                    <li>åœ¨ä¸‹æ–¹å¡«å†™é…ç½®å¹¶ç‚¹å‡»"ä¿å­˜é…ç½®"</li>
                    <li>ç‚¹å‡»"å¯åŠ¨è¿æ¥"å³å¯ä½¿ç”¨</li>
                </ol>
                <div style="margin-top: 8px; padding: 6px 8px; background: #fff3cd; border-radius: 4px; font-size: 12px;">
                    ğŸ’¡ æç¤ºï¼šå¦‚æœä¸‹æ–¹å·²è‡ªåŠ¨å¡«å……é…ç½®ï¼Œè¯´æ˜è¯»å–äº†ä¸Šæ¬¡ä¿å­˜çš„é…ç½®
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>æœåŠ¡å™¨åœ°å€ *</label>
                    <input type="text" id="server" placeholder="ä¾‹å¦‚: 1.2.3.4:8024">
                </div>
                <div class="form-group">
                    <label>éªŒè¯å¯†é’¥ (Vkey) *</label>
                    <input type="text" id="vkey" placeholder="åœ¨æœåŠ¡ç«¯ Web ç®¡ç†ç•Œé¢åˆ›å»ºå®¢æˆ·ç«¯åè·å¾—">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>è¿æ¥ç±»å‹</label>
                    <div class="radio-group">
                        <label><input type="radio" name="connType" value="tcp" checked> TCP</label>
                        <label><input type="radio" name="connType" value="kcp"> KCP</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>æ–­çº¿è¶…æ—¶(ç§’)</label>
                    <input type="number" id="disconnectTimeout" value="60" min="10" max="300">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ä»£ç†åœ°å€ (å¯é€‰)</label>
                    <input type="text" id="proxyUrl" placeholder="socks5://user:pass@127.0.0.1:1080">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="tlsEnable">
                        <label for="tlsEnable">å¯ç”¨ TLS åŠ å¯†</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ç³»ç»ŸæœåŠ¡ç®¡ç†</div>
            <div class="alert alert-info">
                <strong>è¯´æ˜ï¼š</strong>å®‰è£…ä¸ºç³»ç»ŸæœåŠ¡åï¼ŒNPC å°†åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œã€‚<br>
                å®‰è£…æœåŠ¡åéœ€è¦é‡å¯ç³»ç»Ÿæ‰èƒ½ç”Ÿæ•ˆï¼Œæˆ–è€…å…ˆä½¿ç”¨"å¯åŠ¨è¿æ¥"æ‰‹åŠ¨è¿æ¥ã€‚
            </div>
            <div class="service-btns">
                <button class="btn btn-sm btn-primary" onclick="svcInstall()">å®‰è£…æœåŠ¡</button>
                <button class="btn btn-sm btn-danger" onclick="svcUninstall()">å¸è½½æœåŠ¡</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">è¿è¡Œæ—¥å¿—</div>
            <div id="logs" class="logs">ç­‰å¾…å¯åŠ¨...</div>
        </div>
    </div>

    <script>
        function getFormData() {
            return {
                server: document.getElementById('server').value.trim(),
                vkey: document.getElementById('vkey').value.trim(),
                conn_type: document.querySelector('input[name="connType"]:checked').value,
                tls_enable: document.getElementById('tlsEnable').checked,
                proxy_url: document.getElementById('proxyUrl').value.trim(),
                disconnect_timeout: parseInt(document.getElementById('disconnectTimeout').value) || 60
            };
        }

        function setFormData(cfg) {
            if (cfg.server) document.getElementById('server').value = cfg.server;
            if (cfg.vkey) document.getElementById('vkey').value = cfg.vkey;
            if (cfg.conn_type) {
                const radio = document.querySelector('input[name="connType"][value="' + cfg.conn_type + '"]');
                if (radio) radio.checked = true;
            }
            document.getElementById('tlsEnable').checked = cfg.tls_enable || false;
            document.getElementById('proxyUrl').value = cfg.proxy_url || '';
            document.getElementById('disconnectTimeout').value = cfg.disconnect_timeout || 60;
        }

        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                document.getElementById('version').textContent = data.version;
                document.getElementById('logs').textContent = data.logs || 'æ— æ—¥å¿—';

                const runStatus = document.getElementById('runStatus');
                const btnStart = document.getElementById('btnStart');
                const btnStop = document.getElementById('btnStop');

                if (data.running) {
                    runStatus.textContent = 'è¿è¡Œä¸­';
                    runStatus.className = 'status-value running';
                    btnStart.style.display = 'none';
                    btnStop.style.display = 'block';
                } else {
                    runStatus.textContent = 'å·²åœæ­¢';
                    runStatus.className = 'status-value stopped';
                    btnStart.style.display = 'block';
                    btnStop.style.display = 'none';
                }

                const svcStatus = document.getElementById('svcStatus');
                switch (data.svc_status) {
                    case 'running':
                        svcStatus.textContent = 'è¿è¡Œä¸­';
                        svcStatus.className = 'status-value running';
                        break;
                    case 'stopped':
                        svcStatus.textContent = 'å·²åœæ­¢';
                        svcStatus.className = 'status-value stopped';
                        break;
                    case 'not_installed':
                        svcStatus.textContent = 'æœªå®‰è£…';
                        svcStatus.className = 'status-value not_installed';
                        break;
                    default:
                        svcStatus.textContent = 'æœªçŸ¥';
                        svcStatus.className = 'status-value';
                }

                if (data.config) setFormData(data.config);

                const logsEl = document.getElementById('logs');
                logsEl.scrollTop = logsEl.scrollHeight;
            } catch (e) {
                console.error(e);
            }
        }

        async function saveConfig() {
            const cfg = getFormData();
            if (!cfg.server || !cfg.vkey) {
                alert('è¯·å¡«å†™æœåŠ¡å™¨åœ°å€å’ŒéªŒè¯å¯†é’¥');
                return;
            }
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(cfg)
                });
                if (res.ok) {
                    alert('é…ç½®å·²ä¿å­˜');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + await res.text());
                }
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        async function clearConfig() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            try {
                const res = await fetch('/api/config/clear', {method: 'POST'});
                if (res.ok) {
                    alert('é…ç½®å·²æ¸…é™¤');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('server').value = '';
                    document.getElementById('vkey').value = '';
                    document.getElementById('proxyUrl').value = '';
                    document.getElementById('tlsEnable').checked = false;
                    document.querySelector('input[name="connType"][value="tcp"]').checked = true;
                    document.getElementById('disconnectTimeout').value = '60';
                    fetchStatus();
                } else {
                    alert('æ¸…é™¤å¤±è´¥: ' + await res.text());
                }
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        async function startClient() {
            const cfg = getFormData();
            if (!cfg.server || !cfg.vkey) {
                alert('è¯·å¡«å†™æœåŠ¡å™¨åœ°å€å’ŒéªŒè¯å¯†é’¥');
                return;
            }
            await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(cfg)
            });

            try {
                const res = await fetch('/api/start', {method: 'POST'});
                if (!res.ok) alert('å¯åŠ¨å¤±è´¥: ' + await res.text());
                fetchStatus();
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        async function stopClient() {
            try {
                const res = await fetch('/api/stop', {method: 'POST'});
                if (!res.ok) alert('åœæ­¢å¤±è´¥: ' + await res.text());
                fetchStatus();
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        async function svcInstall() {
            const cfg = getFormData();
            if (!cfg.server || !cfg.vkey) {
                alert('è¯·å…ˆå¡«å†™æœåŠ¡å™¨åœ°å€å’ŒéªŒè¯å¯†é’¥');
                return;
            }
            await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(cfg)
            });

            try {
                const res = await fetch('/api/service/install', {method: 'POST'});
                if (res.ok) {
                    alert('æœåŠ¡å®‰è£…æˆåŠŸï¼');
                } else {
                    const errText = await res.text();
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æƒé™é—®é¢˜
                    if (errText.includes('éœ€è¦ç®¡ç†å‘˜æƒé™') || errText.includes('è¯·åœ¨ç»ˆç«¯è¿è¡Œ')) {
                        alert('å®‰è£…å¤±è´¥: ' + errText + '\n\næç¤ºï¼šè¯·å…³é—­æ­¤ç¨‹åºï¼Œåœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥è·å¾—æƒé™æ”¯æŒ');
                    } else {
                        alert('å®‰è£…å¤±è´¥: ' + errText);
                    }
                }
                fetchStatus();
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        async function svcUninstall() {
            if (!confirm('ç¡®å®šè¦å¸è½½ç³»ç»ŸæœåŠ¡å—ï¼Ÿ')) return;
            try {
                const res = await fetch('/api/service/uninstall', {method: 'POST'});
                if (res.ok) {
                    alert('æœåŠ¡å·²å¸è½½');
                } else {
                    alert('å¸è½½å¤±è´¥: ' + await res.text());
                }
                fetchStatus();
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        fetchStatus();
        setInterval(fetchStatus, 2000);
    </script>
</body>
</html>
