# 变更日志

o## [0.26.30] - 2025-07-28
### 新增
- 添加Docker容器升级脚本
  - 创建upgrade_nps.sh脚本，实现一键升级NPS容器
  - 脚本包含配置备份、容器停止、镜像更新、容器重启等完整流程
  - 添加升级结果验证和日志输出功能

### 修复
- 修复下载页面多语言支持问题
  - 修复控制器中模板引用错误，确保正确加载多语言资源
  - 确保所有页面元素通过langtag属性正确标记实现多语言支持

## [0.26.29] - 2025-07-28

### 优化
- 改进客户端版本检查逻辑，支持向后兼容连接
  - 服务端现在可以接受0.26.0及以上版本的客户端连接
  - 添加版本兼容性检查函数，确保连接的客户端版本兼容
  - 优化版本检查日志记录，便于问题排查

## [0.26.28] - 2025-07-27

### 修复
- 修复Docker镜像自动构建失败问题
  - 修复GitHub Actions工作流中的环境变量设置问题
  - 修复标签格式不正确导致构建失败的问题
  - 改善版本号提取逻辑，确保正确构建和标记Docker镜像

## [0.26.27] - 2025-07-27

### 新增
- Docker镜像自动构建功能
  - 添加GitHub Actions工作流，实现多平台Docker镜像自动构建
  - 支持linux/amd64、linux/arm、linux/arm64平台
  - 自动推送latest和版本标签镜像到Docker Hub

## [0.26.26] - 2025-07-26

### 优化
- 核心性能优化：减少锁竞争，使用原子操作替代部分锁操作，优化sync.Map遍历效率
- 流量统计优化：
  - 在Flow结构体中添加AtomicAdd和GetFlow方法，使用原子操作更新流量统计，避免锁竞争
  - 在BaseServer中添加FlowAddAtomic和FlowAddHostAtomic方法，使用原子操作更新流量
- 连接数管理优化：
  - 在Client结构体中优化GetConn方法，使用atomic.LoadInt32直接读取连接数，避免不必要的锁
  - 添加GetNowConn方法，用于原子地获取当前连接数
- sync.Map遍历优化：
  - 优化storeSyncMapToFile函数，使用goroutine和channel并行处理数据序列化和文件写入
  - 减少锁的持有时间，提高并发性能
- 服务器数据统计优化：
  - 在GetDashboardData函数中使用原子操作统计客户端连接数，避免锁竞争
- 接口实现修复：
  - 修复Bridge结构体，确保正确实现NetBridge接口

### 版本更新
- 项目版本从 v0.26.25 更新至 v0.26.26

## 2025-07-26

### 优化
- 简化 README.md 文件，移除过时和不必要的信息
- 更新 go.mod 文件，升级 beego 框架到 v2 版本
- 重构 server/server.go 文件，将全局变量封装到 Server 结构体中
- 在 proxy/base.go 中添加上下文支持，实现优雅关闭
- 在 common/util.go 中添加密码安全功能，使用 Argon2 算法进行密码哈希

### 依赖更新
- 更新 beego 从 v1.12.0 到 v2.1.0
- 更新 kcp-go 到 v5.4.20 正确版本
- 添加 golang.org/x/crypto 依赖用于密码安全功能

### 代码结构改进
- 引入 Server 结构体和单例模式管理服务实例
- 重构全局变量访问方式，提高代码可维护性
- 添加上下文支持，实现更好的资源管理

### 兼容性更新
- 更新所有 beego 导入路径以适配 v2 版本
- 修正相关 API 调用以符合新版本
### Bug修复
- 修复 npc_gui.go 中的 fmt.Errorf 参数不匹配问题
- 解决 cmd/npc 目录中 main 函数重复声明的问题
- 修复 config 包的测试用例问题

### 测试改进
- 修复 pmux 包中的端口冲突问题，更改测试端口从 8888 到 8899
- 修改 pmux 包避免在测试环境中直接调用 os.Exit
- 修改 nps_mux 包测试，使用本地回环地址替代 Docker 网络地址
- 为需要特定网络配置的测试添加跳过条件，提高测试可执行性
- 修复 nps_mux 包测试中的变量使用问题和导入问题